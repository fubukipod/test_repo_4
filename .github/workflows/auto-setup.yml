name: 🔥 Full Auto-Setup Cleaned for test_repo_-2

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened]

jobs:
  ##########################################
  # 1. Create CODEOWNERS & PR Template
  ##########################################
  init-files:
    name: 🛠 Create CODEOWNERS & PR Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Create required files
        run: |
          mkdir -p .github
          echo "*   @softservedata" > .github/CODEOWNERS
          cat <<'EOF' > .github/pull_request_template.md
          ## Describe your changes
          -

          ## Issue ticket number and link
          -

          ## Checklist before requesting a review
          - [ ] I have performed a self-review of my code
          - [ ] If it is a core feature, I have added thorough tests
          - [ ] Do we need to implement analytics?
          - [ ] Will this be part of a product update? If yes, describe briefly
          EOF

      - name: Commit changes to a new branch (PR flow)
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/fubukipod/test_repo_-2
          BRANCH=auto-setup-bot-templates-$(date +%s)
          git checkout -b $BRANCH
          git add .github/CODEOWNERS .github/pull_request_template.md
          git commit -m "Automated: Added CODEOWNERS & PR template" || echo "No changes"
          git push origin $BRANCH
          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: Open PR for templates
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT }}
          branch: ${{ env.branch }}
          base: main
          title: "Automated: Add CODEOWNERS & PR Template"
          body: |
            This PR was automatically created to add CODEOWNERS and PR template.

  ##########################################
  # 2. Invite collaborator
  ##########################################
  invite-collaborator:
    name: 🤝 Invite softservedata
    runs-on: ubuntu-latest
    needs: init-files
    steps:
      - name: Invite collaborator via API
        run: |
          curl -X PUT \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/fubukipod/test_repo_-2/collaborators/softservedata \
            -d '{"permission":"push"}'

  ##########################################
  # 3. Ensure develop branch exists & set default
  ##########################################
  create-develop:
    name: 🌱 Ensure develop branch via PR
    runs-on: ubuntu-latest
    needs: invite-collaborator
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Create develop branch (PR flow)
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/fubukipod/test_repo_-2
          if ! git ls-remote --heads https://x-access-token:${{ secrets.PAT }}@github.com/fubukipod/test_repo_-2 develop | grep develop; then
            BRANCH=auto-setup-bot-develop-$(date +%s)
            git checkout -b $BRANCH
            echo "# Develop branch initialized" > DEVELOP_INIT.md
            git add DEVELOP_INIT.md
            git commit -m "Automated: Initialize develop branch"
            git push origin $BRANCH
            echo "branch=$BRANCH" >> $GITHUB_ENV
          else
            echo "Develop branch already exists." && echo "branch=develop" >> $GITHUB_ENV
          fi

      - name: Open PR to create develop
        if: env.branch != 'develop'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT }}
          branch: ${{ env.branch }}
          base: main
          title: "Automated: Create develop branch"
          body: |
            This PR was automatically created to initialize the develop branch.

      - name: Set develop as default branch via API
        run: |
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/fubukipod/test_repo_-2 \
            -d '{"default_branch":"develop"}'

  ##########################################
  # 4. Apply branch protection rules
  ##########################################
  branch-protection:
    name: 🔒 Apply Branch Protection Rules
    runs-on: ubuntu-latest
    needs: create-develop
    steps:
      - name: Protect main branch
        run: |
          curl -X PUT \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github.luke-cage-preview+json" \
            https://api.github.com/repos/fubukipod/test_repo_-2/branches/main/protection \
            -d '{"required_pull_request_reviews":{"required_approving_review_count":1},"enforce_admins":true,"restrictions":null,"required_status_checks":null}'

      - name: Protect develop branch
        run: |
          curl -X PUT \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github.luke-cage-preview+json" \
            https://api.github.com/repos/fubukipod/test_repo_-2/branches/develop/protection \
            -d '{"required_pull_request_reviews":{"required_approving_review_count":2},"enforce_admins":true,"restrictions":null,"required_status_checks":null}'

  ##########################################
  # 5. Generate & add deploy key
  ##########################################
  add-deploy-key:
    name: 🔑 Add Deploy Key (API fixed)
    runs-on: ubuntu-latest
    needs: branch-protection
    steps:
      - name: Generate SSH key
        run: |
          ssh-keygen -t rsa -b 4096 -C "deploy_key" -f deploy_key -N ""
          echo "PRIVATE_KEY<<EOF" >> $GITHUB_ENV
          cat deploy_key >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Upload deploy key via API
        run: |
          PUB_KEY=$(cat deploy_key.pub)
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/fubukipod/test_repo_-2/keys \
            -d "{\"title\":\"DEPLOY_KEY\",\"key\":\"$PUB_KEY\",\"read_only\":false}"

  ##########################################
  # 6. Create GitHub project board
  ##########################################
  create-project:
    name: 📋 Create Project Board
    runs-on: ubuntu-latest
    needs: add-deploy-key
    steps:
      - name: Create project board via API
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github.inertia-preview+json" \
            https://api.github.com/repos/fubukipod/test_repo_-2/projects \
            -d '{"name":"Automated Project","body":"Board created by GitHub Action"}'

  ##########################################
  # 7. Notify Discord on PR creation
  ##########################################
  notify-discord:
    name: 📢 Discord PR Notification
    runs-on: ubuntu-latest
    needs: create-project
    steps:
      - name: Send Discord Notification
        uses: Ilshidur/action-discord@master
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: |
            🚀 **New PR in test_repo_-2**
            🔹 Title: ${{ github.event.pull_request.title }}
            👤 Author: ${{ github.actor }}
            🔗 Link: ${{ github.event.pull_request.html_url }}
