name: üî• Full Auto-Setup for test_repo_-2

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened]

jobs:
  ##########################################
  # 1. Create CODEOWNERS & PR Template
  ##########################################
  init-files:
    name: üõ† Create CODEOWNERS & PR Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Create required files
        run: |
          mkdir -p .github
          echo "*   @softservedata" > .github/CODEOWNERS
          cat <<'EOF' > .github/pull_request_template.md
          ## Describe your changes
          -

          ## Issue ticket number and link
          -

          ## Checklist before requesting a review
          - [ ] I have performed a self-review of my code
          - [ ] If it is a core feature, I have added thorough tests
          - [ ] Do we need to implement analytics?
          - [ ] Will this be part of a product update? If yes, describe briefly
          EOF

      - name: Commit and push templates (safe rebase)
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/fubukipod/test_repo_-2
          git fetch origin main
          git rebase origin/main || echo "No rebase needed"
          git add .github/CODEOWNERS .github/pull_request_template.md
          git commit -m "Automated: Added CODEOWNERS & PR template" || echo "No changes to commit"
          git push origin HEAD:main --force-with-lease

  ##########################################
  # 2. Invite collaborator
  ##########################################
  invite-collaborator:
    name: ü§ù Invite softservedata
    runs-on: ubuntu-latest
    needs: init-files
    steps:
      - name: Send collaborator invite
        uses: octokit/request-action@v2.x
        with:
          route: PUT /repos/fubukipod/test_repo_-2/collaborators/softservedata
          data: '{"permission":"push"}'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

  ##########################################
  # 3. Ensure develop branch exists & set as default
  ##########################################
  create-develop:
    name: üå± Ensure develop branch & set default
    runs-on: ubuntu-latest
    needs: invite-collaborator
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Create develop if missing (safe push)
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/fubukipod/test_repo_-2
          git fetch origin main
          if ! git ls-remote --heads https://x-access-token:${{ secrets.PAT }}@github.com/fubukipod/test_repo_-2 develop | grep develop; then
            echo "Creating develop branch..."
            git checkout -b develop origin/main
            git push origin develop --force-with-lease
          else
            echo "Develop branch already exists."
          fi

      - name: Set develop as default
        uses: octokit/request-action@v2.x
        with:
          route: PATCH /repos/fubukipod/test_repo_-2
          data: '{"default_branch":"develop"}'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

  ##########################################
  # 4. Apply branch protection rules
  ##########################################
  branch-protection:
    name: üîí Apply Branch Protection Rules
    runs-on: ubuntu-latest
    needs: create-develop
    steps:
      - name: Protect main (1 approval)
        uses: octokit/request-action@v2.x
        with:
          route: PUT /repos/fubukipod/test_repo_-2/branches/main/protection
          mediaType: '{"previews": ["luke-cage"]}'
          data: |
            required_pull_request_reviews:
              required_approving_review_count: 1
            enforce_admins: true
            restrictions: null
            required_status_checks: null
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

      - name: Protect develop (2 approvals)
        uses: octokit/request-action@v2.x
        with:
          route: PUT /repos/fubukipod/test_repo_-2/branches/develop/protection
          mediaType: '{"previews": ["luke-cage"]}'
          data: |
            required_pull_request_reviews:
              required_approving_review_count: 2
            enforce_admins: true
            restrictions: null
            required_status_checks: null
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

  ##########################################
  # 5. Generate & add deploy key
  ##########################################
  add-deploy-key:
    name: üîë Add Deploy Key
    runs-on: ubuntu-latest
    needs: branch-protection
    steps:
      - name: Generate key
        run: |
          ssh-keygen -t rsa -b 4096 -C "deploy_key" -f deploy_key -N ""
          echo "PRIVATE_KEY<<EOF" >> $GITHUB_ENV
          cat deploy_key >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Upload key
        uses: octokit/request-action@v2.x
        with:
          route: POST /repos/fubukipod/test_repo_-2/keys
          data: |
            {
              "title": "DEPLOY_KEY",
              "key": "$(cat deploy_key.pub)",
              "read_only": false
            }
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

  ##########################################
  # 6. Create GitHub project board
  ##########################################
  create-project:
    name: üìã Create Project Board
    runs-on: ubuntu-latest
    needs: add-deploy-key
    steps:
      - name: Create project
        uses: octokit/request-action@v2.x
        with:
          route: POST /repos/fubukipod/test_repo_-2/projects
          mediaType: '{"previews": ["inertia"]}'
          data: '{"name":"Automated Project","body":"Board created by GitHub Action"}'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

  ##########################################
  # 7. Notify Discord on PR creation
  ##########################################
  notify-discord:
    name: üì¢ Discord PR Notification
    runs-on: ubuntu-latest
    needs: create-project
    steps:
      - name: Send Discord Message
        uses: Ilshidur/action-discord@master
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: |
            üöÄ **New PR in test_repo_-2**
            üîπ Title: ${{ github.event.pull_request.title }}
            üë§ Author: ${{ github.actor }}
            üîó Link: ${{ github.event.pull_request.html_url }}
